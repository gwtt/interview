### Redis为什么需要集群

> - 首先集群解决单节点故障问题，提高系统的可用性
> - 提升并发作业能力



### Redis一般如何实现集群

> **方式1：Cluster**(面试时主要答这个)
>
> **这是Redis 自带的集群功能**，它采用的分布式算法是**哈希槽**，而不是一致性Hash。支持主从结构，可以扩展多个从服务器，当主节点挂了可以很快切换到一个从节点作主节点，然后其他从节点都会切换读取最新的主节点。
>
> **方式2：Twemproxy**
>
> Twitter 开源的一个轻量级后端代理。可以管理 Redis 或 Memcache 集群。相对于 Redis 集群来说，易于管理。它的使用方法和Redis集群没有任何区别，只需要设置多个Redis实例后，在本需要连接 Redis 的地方改为连接 Twemproxy ，它就会以一个代理的身份接收请求并使用一致性Hash算法，将请求连接到具体的Redis节点上，将结果再返回Twemproxy。对于客户端来说，Twemproxy 相当于是缓存数据库的总入口，它不需要知道后端如何部署的。Twemproxy 会检测与每个节点的连接是否正常，如果存在异常节点就会将其剔除，等一段时间后，Twemproxy 还会再次尝试连接被剔除的节点。
>
> **方式3：Codis**
>
> 它是一个 Redis 分布式的解决方法，对于应用使用 Codis Proxy 的连接和使用Redis的服务没有明显区别，应用能够像使用单机 Redis 一样，让 Codis 底层处理请求转发，实现不停机实现数据迁移等工作。



### Redis集群的三种模式

> **主从模式**：master 节点挂掉后，需要手动指定新的 master，可用性不高，基本不用。
>
> **哨兵模式**：master 节点挂掉后，哨兵进程会主动选举新的 master，可用性高，但是每个节点存储的数据是一样的，浪费内存空间。数据量不是很多，集群规模不是很大，需要自动容错容灾的时候使用。
>
> **Redis cluster**：主要是针对海量数据+高并发+高可用的场景，如果是海量数据，如果你的数据量很大，那么建议就用Redis cluster，所有主节点的容量总和就是Redis cluster可缓存的数据容量。
>
> 上次的面试官告诉我，实际业务中集群指的就是Redis cluster

#### 主从模式

设置很简单

```cmd
start redis-server.exe --port 6379 
start redis-server.exe --port 6380 --slaveof 127.0.0.1 6379 
这边显示了主要用slaveof这边来配置主从关系
```

![image-20221204195544549](Redis集群模式/image-20221204195544549.png)

为什么生产环境不用呢，因为master挂了之后，这个slave根本不会变成master结点。

#### 哨兵模式

针对主从模式的缺点，我们推行了哨兵模式

其实本质上很简单，在主从模式中我们添加了哨兵来监控主结点和从结点，如果master宕机，**则选择一个从结点当主节点**（这边使用了发布订阅模式）

![image-20221204200733184](Redis集群模式/image-20221204200733184.png)

#### Rediscluster模式（多主多从）

生产环境中一般都用这个模式

因为哨兵模式虽然解决了高可用和读写分离问题，但是每台redis服务都需要存储相同的服务，浪费内存，水平扩容不行。

**redis集群采用p2p模式，去中心化，不存在中心节点和代理节点**

**redis没有统一入口，客户端连接集群中的任意节点即可**

**redis cluster有这么一个投票容错机制：如果集群中找过半数的节点投票认为某节点挂了，那么该节点就挂了**

**redis集群至少需要3个主节点**：因为投票容错机制要求超过半数节点认为某节点挂了该节点才是挂了，所以2个节点服务构建集群。

**redis集群至少需要6台服务器**

- 因为要保证集群的高可用，需要每个主节点都有至少一个从节点（备份节点）
- 如果手上没那么多服务，也可以采用伪分布式集群搭法，即一台物理机启动多个redis实例

![image-20221205161827741](Redis集群模式/image-20221205161827741.png)